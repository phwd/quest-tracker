package com.oculus.http.core.interceptor;

import X.AbstractC06640p5;
import X.AnonymousClass0DD;
import X.AnonymousClass0J2;
import X.AnonymousClass0NO;
import X.AnonymousClass0QC;
import X.AnonymousClass117;
import X.C08220wC;
import X.C08330wN;
import X.C08340wO;
import X.C08780ya;
import X.C08830yf;
import android.annotation.SuppressLint;
import android.text.TextUtils;
import com.facebook.ultralight.AutoGeneratedAccessMethod;
import com.facebook.ultralight.AutoGeneratedFactoryMethod;
import com.facebook.ultralight.Dependencies;
import com.facebook.ultralight.Inject;
import com.oculus.auth.credentials.Credentials;
import com.oculus.auth.credentials.CredentialsModule;
import com.oculus.auth.storage.AuthDatastore;
import com.oculus.auth.storage.StorageModule;
import com.oculus.auth.util.AccessTokenUtils;
import com.oculus.authapi.OVRAuth;
import com.oculus.base.app.AppInfo;
import com.oculus.dsatauth.DsatFetcher;
import com.oculus.http.core.base.ApiError;
import com.oculus.http.core.common.Authorization;
import com.oculus.http.core.common.DsatAuthorization;
import com.oculus.logging.utils.Event;
import com.oculus.logging.utils.EventManager;
import com.oculus.os.DeviceAuth;
import com.oculus.util.constants.OculusConstants;
import java.io.IOException;
import java.util.concurrent.TimeUnit;
import javax.inject.Provider;

@Dependencies({"_UL__ULSEP_com_oculus_auth_credentials_Credentials_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_base_app_AppInfo_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_auth_storage_AuthDatastore_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_os_DeviceAuth_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_dsatauth_DsatFetcher_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_logging_utils_EventManager_ULSEP_BINDING_ID"})
public class OculusAuthorizationInterceptor extends AuthorizationInterceptor {
    public static final String ACTION_AUTO_LOGOUT = "com.oculus.auth.ACTION_AUTO_LOGOUT";
    public static final long CREDENTIALS_UPDATE_WINDOW_MS = TimeUnit.SECONDS.toMillis(5);
    public static final long DSAT_FETCH_TIMEOUT_SECONDS = 30;
    public static final String EVENT_AUTH_ACTION = "oculus_mobile_auth_action";
    public static final String EXTRA_ACTION = "action";
    public static final String EXTRA_ERROR_CODE = "error_code";
    public static final String EXTRA_ERROR_MESSAGE = "error_message";
    public static final String EXTRA_ERROR_SUBCODE = "error_subcode";
    public static final String EXTRA_ERROR_TYPE = "error_type";
    public static final String EXTRA_ERROR_USER_MESSAGE = "error_user_message";
    public static final String EXTRA_ERROR_USER_TITLE = "error_user_title";
    public static final String TAG = "OculusAuthorizationInterceptor";
    public AnonymousClass0QC _UL_mInjectionContext;
    @Inject
    public final Provider<AuthDatastore> mAuthDatastoreProvider;
    @Inject
    public final Provider<Credentials> mCredentialsProvider;

    private String A02() {
        String str;
        try {
            str = ((DeviceAuth) AnonymousClass0J2.A03(1, 82, this._UL_mInjectionContext)).fetchToken(OculusConstants.ALPENGLOW_HW_LOGINTOKEN).value();
        } catch (DeviceAuth.BackendException | DeviceAuth.DeviceIdentityException | DeviceAuth.NetworkException | InterruptedException e) {
            AnonymousClass0NO.A0H(TAG, e, "Error fetching device auth token");
            if (e instanceof InterruptedException) {
                Thread.currentThread().interrupt();
            }
            str = null;
        }
        if (TextUtils.isEmpty(str)) {
            return AccessTokenUtils.createLoggedOutToken((AppInfo) AnonymousClass0J2.A03(0, 560, this._UL_mInjectionContext), null);
        }
        return AccessTokenUtils.createLoggedOutToken((AppInfo) AnonymousClass0J2.A03(0, 560, this._UL_mInjectionContext), str);
    }

    @AutoGeneratedAccessMethod
    public static final OculusAuthorizationInterceptor A00(AbstractC06640p5 r1) {
        return (OculusAuthorizationInterceptor) AnonymousClass117.A00(35, r1);
    }

    @AutoGeneratedFactoryMethod
    public static final OculusAuthorizationInterceptor A01(AbstractC06640p5 r1) {
        return new OculusAuthorizationInterceptor(r1);
    }

    @Override // com.oculus.http.core.interceptor.AuthorizationInterceptor
    public final C08340wO A03(C08330wN r5) throws IOException {
        String A00 = r5.A02.A00(DsatAuthorization.INTERNAL_PARAMETER_HEADER);
        C08340wO r2 = new C08340wO(r5);
        r2.A03.A01(DsatAuthorization.INTERNAL_PARAMETER_HEADER);
        r2.A02("Authorization", Authorization.A00(A05(A00)));
        return r2;
    }

    @Override // com.oculus.http.core.interceptor.AuthorizationInterceptor
    @SuppressLint({"BadMethodUse-java.lang.System.currentTimeMillis"})
    public final void A04(C08220wC r6) {
        ApiError.FBApiErrorResponse.Error error;
        if (Math.abs(System.currentTimeMillis() - this.mAuthDatastoreProvider.get().getCredentialsUpdateTimeMillis()) >= CREDENTIALS_UPDATE_WINDOW_MS) {
            try {
                String A01 = r6.A0B.A01();
                AnonymousClass0NO.A0E(TAG, "Logging user out, response: %s", A01);
                ApiError.FBApiErrorResponse fBApiErrorResponse = (ApiError.FBApiErrorResponse) new C08780ya().A05(A01, ApiError.FBApiErrorResponse.class);
                Event A22 = ((EventManager) AnonymousClass0J2.A03(3, 242, this._UL_mInjectionContext)).A22("oculus_mobile_auth_action");
                A22.A15("action", ACTION_AUTO_LOGOUT);
                if (!(fBApiErrorResponse == null || (error = fBApiErrorResponse.error) == null)) {
                    A22.A13("error_code", error.code);
                    A22.A13("error_subcode", error.error_subcode);
                    String str = error.type;
                    if (str != null) {
                        A22.A15("error_type", str);
                    }
                    String str2 = error.message;
                    if (str2 != null) {
                        A22.A15("error_message", str2);
                    }
                    String str3 = error.error_user_title;
                    if (str3 != null) {
                        A22.A15("error_user_title", str3);
                    }
                    String str4 = error.error_user_msg;
                    if (str4 != null) {
                        A22.A15(EXTRA_ERROR_USER_MESSAGE, str4);
                    }
                }
                A22.A5L();
            } catch (C08830yf | IOException e) {
                AnonymousClass0NO.A0I(TAG, e, "Error processing response");
            }
            this.mAuthDatastoreProvider.get().clearCredentials();
        }
    }

    public final String A05(String str) throws IOException {
        String str2;
        if (!DsatAuthorization.INTERNAL_HEADER_REQUIRES_DSAT.equals(str)) {
            Credentials credentials = this.mCredentialsProvider.get();
            if (credentials != null) {
                return credentials.mAccessToken;
            }
            return A02();
        }
        DsatFetcher dsatFetcher = (DsatFetcher) AnonymousClass0J2.A03(2, 112, this._UL_mInjectionContext);
        AnonymousClass0DD r3 = new AnonymousClass0DD();
        if (dsatFetcher.mIsDeviceMissingIdentity) {
            Credentials credentials2 = dsatFetcher.mCredentialsProvider.get();
            if (credentials2 == null) {
                str2 = null;
            } else {
                str2 = credentials2.mAccessToken;
            }
            r3.A02(str2);
        } else {
            ((OVRAuth) AnonymousClass0J2.A03(0, 210, dsatFetcher._UL_mInjectionContext)).A03(
            /*  JADX ERROR: Method code generation error
                jadx.core.utils.exceptions.CodegenException: Error generate insn: 0x0054: INVOKE  
                  (wrap: com.oculus.authapi.OVRAuth : 0x004d: CHECK_CAST (r1v3 com.oculus.authapi.OVRAuth) = (com.oculus.authapi.OVRAuth) (wrap: java.lang.Object : 0x0049: INVOKE  (r1v2 java.lang.Object) = 
                  (0 int)
                  (210 int)
                  (wrap: X.0QC : 0x0047: IGET  (r0v4 X.0QC) = (r4v1 'dsatFetcher' com.oculus.dsatauth.DsatFetcher) com.oculus.dsatauth.DsatFetcher._UL_mInjectionContext X.0QC)
                 type: STATIC call: X.0J2.A03(int, int, X.0QC):java.lang.Object))
                  (wrap: com.oculus.dsatauth.DsatFetcher$1 : 0x0051: CONSTRUCTOR  (r0v5 com.oculus.dsatauth.DsatFetcher$1) = (r4v1 'dsatFetcher' com.oculus.dsatauth.DsatFetcher), (r3v0 'r3' X.0DD) call: com.oculus.dsatauth.DsatFetcher.1.<init>(com.oculus.dsatauth.DsatFetcher, X.0DD):void type: CONSTRUCTOR)
                 type: VIRTUAL call: com.oculus.authapi.OVRAuth.A03(com.oculus.authapi.AuthResultCallback):void in method: com.oculus.http.core.interceptor.OculusAuthorizationInterceptor.A05(java.lang.String):java.lang.String, file: classes.dex
                	at jadx.core.codegen.InsnGen.makeInsn(InsnGen.java:255)
                	at jadx.core.codegen.InsnGen.makeInsn(InsnGen.java:217)
                	at jadx.core.codegen.RegionGen.makeSimpleBlock(RegionGen.java:110)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:56)
                	at jadx.core.codegen.RegionGen.makeSimpleRegion(RegionGen.java:93)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:59)
                	at jadx.core.codegen.RegionGen.makeRegionIndent(RegionGen.java:99)
                	at jadx.core.codegen.RegionGen.makeIf(RegionGen.java:157)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:63)
                	at jadx.core.codegen.RegionGen.makeSimpleRegion(RegionGen.java:93)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:59)
                	at jadx.core.codegen.RegionGen.makeSimpleRegion(RegionGen.java:93)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:59)
                	at jadx.core.codegen.RegionGen.makeSimpleRegion(RegionGen.java:93)
                	at jadx.core.codegen.RegionGen.makeRegion(RegionGen.java:59)
                	at jadx.core.codegen.MethodGen.addRegionInsns(MethodGen.java:244)
                	at jadx.core.codegen.MethodGen.addInstructions(MethodGen.java:237)
                	at jadx.core.codegen.ClassGen.addMethodCode(ClassGen.java:342)
                	at jadx.core.codegen.ClassGen.addMethod(ClassGen.java:295)
                	at jadx.core.codegen.ClassGen.lambda$addInnerClsAndMethods$2(ClassGen.java:264)
                	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)
                	at java.util.ArrayList.forEach(ArrayList.java:1259)
                	at java.util.stream.SortedOps$RefSortingSink.end(SortedOps.java:395)
                	at java.util.stream.Sink$ChainedReference.end(Sink.java:258)
                Caused by: jadx.core.utils.exceptions.CodegenException: Error generate insn: 0x0051: CONSTRUCTOR  (r0v5 com.oculus.dsatauth.DsatFetcher$1) = (r4v1 'dsatFetcher' com.oculus.dsatauth.DsatFetcher), (r3v0 'r3' X.0DD) call: com.oculus.dsatauth.DsatFetcher.1.<init>(com.oculus.dsatauth.DsatFetcher, X.0DD):void type: CONSTRUCTOR in method: com.oculus.http.core.interceptor.OculusAuthorizationInterceptor.A05(java.lang.String):java.lang.String, file: classes.dex
                	at jadx.core.codegen.InsnGen.makeInsn(InsnGen.java:255)
                	at jadx.core.codegen.InsnGen.addWrappedArg(InsnGen.java:119)
                	at jadx.core.codegen.InsnGen.addArg(InsnGen.java:103)
                	at jadx.core.codegen.InsnGen.generateMethodArguments(InsnGen.java:806)
                	at jadx.core.codegen.InsnGen.makeInvoke(InsnGen.java:746)
                	at jadx.core.codegen.InsnGen.makeInsnBody(InsnGen.java:367)
                	at jadx.core.codegen.InsnGen.makeInsn(InsnGen.java:249)
                	... 23 more
                Caused by: jadx.core.utils.exceptions.JadxRuntimeException: Expected class to be processed at this point, class: com.oculus.dsatauth.DsatFetcher, state: GENERATED_AND_UNLOADED
                	at jadx.core.dex.nodes.ClassNode.ensureProcessed(ClassNode.java:215)
                	at jadx.core.codegen.InsnGen.makeConstructor(InsnGen.java:630)
                	at jadx.core.codegen.InsnGen.makeInsnBody(InsnGen.java:363)
                	at jadx.core.codegen.InsnGen.makeInsn(InsnGen.java:230)
                	... 29 more
                */
            /*
            // Method dump skipped, instructions count: 152
            */
            throw new UnsupportedOperationException("Method not decompiled: com.oculus.http.core.interceptor.OculusAuthorizationInterceptor.A05(java.lang.String):java.lang.String");
        }

        @Inject
        public OculusAuthorizationInterceptor(AbstractC06640p5 r3) {
            this._UL_mInjectionContext = new AnonymousClass0QC(4, r3);
            this.mCredentialsProvider = CredentialsModule._UL__ULSEP_javax_inject_Provider_ULLT_com_oculus_auth_credentials_Credentials_ULGT__ULSEP_ACCESS_METHOD(r3);
            this.mAuthDatastoreProvider = StorageModule._UL__ULSEP_javax_inject_Provider_ULLT_com_oculus_auth_storage_AuthDatastore_ULGT__ULSEP_ACCESS_METHOD(r3);
        }
    }
