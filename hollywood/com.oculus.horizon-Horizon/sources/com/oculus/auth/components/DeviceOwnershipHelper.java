package com.oculus.auth.components;

import X.AbstractC06640p5;
import X.AnonymousClass0D4;
import X.AnonymousClass0DC;
import X.AnonymousClass0I1;
import X.AnonymousClass0J2;
import X.AnonymousClass0NO;
import X.AnonymousClass0QC;
import X.AnonymousClass0p1;
import X.AnonymousClass117;
import X.C003008y;
import X.C01020Iw;
import android.content.Context;
import android.content.SharedPreferences;
import com.facebook.ultralight.AutoGeneratedAccessMethod;
import com.facebook.ultralight.AutoGeneratedFactoryMethod;
import com.facebook.ultralight.Dependencies;
import com.facebook.ultralight.Inject;
import com.google.common.base.Optional;
import com.oculus.auth.api.AuthMethods;
import com.oculus.horizon.api.ApiTaskCallback;
import com.oculus.multiuser.UserClassifier;
import com.squareup.okhttp.internal.DiskLruCache;
import javax.inject.Provider;

@Dependencies({"_UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_multiuser_UserClassifier_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_auth_components_HorizonDsatHelper_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_auth_api_AuthMethods_ULSEP_BINDING_ID", "_UL__ULSEP_com_oculus_auth_components_AuthComponentRunner_ULSEP_BINDING_ID"})
public class DeviceOwnershipHelper {
    public static final String KEY_IS_SET = "is_set";
    public static final String PREFS_NAME = "device_ownership";
    public static final String TAG = "DeviceOwnershipHelper";
    public AnonymousClass0QC _UL_mInjectionContext;
    public final SharedPreferences mPrefs;

    /* access modifiers changed from: private */
    /* access modifiers changed from: public */
    private AnonymousClass0DC<Void> setOwnershipOnBackendAsync(Optional<String> optional, AuthAction authAction) {
        return ((AuthComponentRunner) AnonymousClass0J2.A03(5, 6, this._UL_mInjectionContext)).runAsync(doSetOwnershipOnBackendAsync(optional), AuthLogger.COMPONENT_SET_DEVICE_OWNERSHIP, authAction);
    }

    @AutoGeneratedAccessMethod
    public static final AnonymousClass0p1 _UL__ULSEP_com_facebook_inject_Lazy_ULLT_com_oculus_auth_components_DeviceOwnershipHelper_ULGT__ULSEP_ACCESS_METHOD(AbstractC06640p5 r2) {
        return new C003008y(23, r2);
    }

    @AutoGeneratedAccessMethod
    public static final DeviceOwnershipHelper _UL__ULSEP_com_oculus_auth_components_DeviceOwnershipHelper_ULSEP_ACCESS_METHOD(AbstractC06640p5 r1) {
        return (DeviceOwnershipHelper) AnonymousClass117.A00(23, r1);
    }

    @AutoGeneratedFactoryMethod
    public static final DeviceOwnershipHelper _UL__ULSEP_com_oculus_auth_components_DeviceOwnershipHelper_ULSEP_FACTORY_METHOD(AbstractC06640p5 r1) {
        return new DeviceOwnershipHelper(r1);
    }

    @AutoGeneratedAccessMethod
    public static final Provider _UL__ULSEP_javax_inject_Provider_ULLT_com_oculus_auth_components_DeviceOwnershipHelper_ULGT__ULSEP_ACCESS_METHOD(AbstractC06640p5 r2) {
        return new C01020Iw(23, r2);
    }

    /* access modifiers changed from: private */
    /* access modifiers changed from: public */
    private void setIsOwnershipSet() {
        this.mPrefs.edit().putBoolean(KEY_IS_SET, true).apply();
    }

    private AnonymousClass0DC<Void> setOwnershipAsync(final AuthAction authAction) {
        return ((HorizonDsatHelper) AnonymousClass0J2.A03(3, 347, this._UL_mInjectionContext)).fetchTokenAsync(authAction).A0D(new AnonymousClass0D4<Optional<String>, AnonymousClass0DC<Void>>() {
            /* class com.oculus.auth.components.DeviceOwnershipHelper.AnonymousClass2 */

            @Override // X.AnonymousClass0D4
            public AnonymousClass0DC<Void> then(AnonymousClass0DC<Optional<String>> r4) {
                return DeviceOwnershipHelper.this.setOwnershipOnBackendAsync(r4.A0G(), authAction);
            }
        }, AnonymousClass0DC.A0A).A0B(new AnonymousClass0D4<Void, Void>() {
            /* class com.oculus.auth.components.DeviceOwnershipHelper.AnonymousClass1 */

            @Override // X.AnonymousClass0D4
            public Void then(AnonymousClass0DC<Void> r2) {
                DeviceOwnershipHelper.this.setIsOwnershipSet();
                return null;
            }
        });
    }

    public AnonymousClass0DC<Void> ensureOwnershipAsync(AuthAction authAction) {
        if (!((UserClassifier) AnonymousClass0J2.A03(1, 468, this._UL_mInjectionContext)).A01()) {
            return AnonymousClass0DC.A03(new GenericError("User is not primary"));
        }
        if (!isOwnershipSet()) {
            if (!AnonymousClass0I1.A02("debug.oculus.disable_device_identity_features").equals(DiskLruCache.VERSION_1)) {
                return setOwnershipAsync(authAction);
            }
            AnonymousClass0NO.A09(TAG, "Device identity features disabled");
        }
        return AnonymousClass0DC.A04(null);
    }

    public boolean isOwnershipSet() {
        return this.mPrefs.getBoolean(KEY_IS_SET, false);
    }

    public void resetIsOwnershipSet() {
        this.mPrefs.edit().putBoolean(KEY_IS_SET, false).apply();
    }

    @Inject
    public DeviceOwnershipHelper(AbstractC06640p5 r4) {
        AnonymousClass0QC r1 = new AnonymousClass0QC(6, r4);
        this._UL_mInjectionContext = r1;
        this.mPrefs = ((Context) AnonymousClass0J2.A03(0, 294, r1)).getSharedPreferences(PREFS_NAME, 0);
    }

    private AnonymousClass0DC<Void> doSetOwnershipOnBackendAsync(Optional<String> optional) {
        if (!optional.isPresent()) {
            return AnonymousClass0DC.A03(new GenericError("Not logged in"));
        }
        ApiTaskCallback apiTaskCallback = new ApiTaskCallback();
        ((AuthMethods) AnonymousClass0J2.A03(4, 84, this._UL_mInjectionContext)).setDeviceOwner(optional.get(), apiTaskCallback);
        return apiTaskCallback.mCompletionSource.A00;
    }
}
