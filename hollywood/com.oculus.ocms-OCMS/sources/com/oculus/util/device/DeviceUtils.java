package com.oculus.util.device;

import android.annotation.SuppressLint;
import android.annotation.TargetApi;
import android.content.Context;
import android.os.Build;
import android.os.Environment;
import android.os.StatFs;
import android.provider.Settings;
import com.facebook.androidinternals.android.os.SystemPropertiesInternal;
import com.facebook.debug.log.BLog;
import com.facebook.inject.BundledAndroidModule;
import com.facebook.inject.InjectorLike;
import com.facebook.inject.Lazy;
import com.facebook.inject.UltralightLazy;
import com.facebook.inject.UltralightProvider;
import com.facebook.inject.UnsafeContextInjection;
import com.facebook.ipc.activity.ActivityConstants;
import com.facebook.ultralight.AutoGeneratedAccessMethod;
import com.facebook.ultralight.AutoGeneratedFactoryMethod;
import com.facebook.ultralight.Dependencies;
import com.facebook.ultralight.Eager;
import com.facebook.ultralight.UL;
import com.google.common.base.Strings;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.UnmodifiableIterator;
import com.oculus.common.build.BuildConstants;
import com.oculus.util.device.DeviceModule;
import java.io.File;
import javax.annotation.Nullable;
import javax.inject.Inject;
import javax.inject.Provider;

@Dependencies({"_UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_UnsafeContextInjection_ULSEP_BINDING_ID"})
@TargetApi(21)
public class DeviceUtils {
    private static final ImmutableSet<String> ALL_MODELS = ImmutableSet.builder().add((Object[]) new String[]{"SM-N910", "SM-N916", "SC-05G", "SC-04G", "SCV31", "404SC", "SM-G920", "SM-G925"}).build();
    private static final int DEFAULT_THRESHOLD_MAX_BYTES = 524288000;
    private static final int DEFAULT_THRESHOLD_PERCENTAGE = 10;
    private static final String EXTERNAL_STORAGE_FILE_PATH = Environment.getExternalStorageDirectory().getPath();
    private static final String FAKE_MODEL_PLACEHOLDER = "fake_placeholder";
    private static final ImmutableSet<String> JAPAN_MODELS = ImmutableSet.builder().add((Object[]) new String[]{"SC-05G", "SC-04G", "SCV31", "404SC"}).build();
    private static final String MODEL_DEBUG_FILE_PATH = (EXTERNAL_STORAGE_FILE_PATH + "/oculus_model.test");
    private static final ImmutableSet<String> NOTE4_MODELS = ImmutableSet.builder().add((Object[]) new String[]{"SM-N910", "SM-N916"}).build();
    private static final String OCULUS_DIR = "Oculus";
    private static final String STORAGE_THRESHOLD_MAX_BYTES = "sys_storage_threshold_max_bytes";
    private static final String STORAGE_THRESHOLD_PERCENTAGE = "sys_storage_threshold_percentage";
    private static final String TAG = "DeviceUtils";
    private static String mFakeModel;
    @UnsafeContextInjection
    @Inject
    @Eager
    private final Context mContext;

    @AutoGeneratedAccessMethod
    public static final Lazy _UL__ULSEP_com_facebook_inject_Lazy_ULLT_com_oculus_util_device_DeviceUtils_ULGT__ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return UltralightLazy.get(DeviceModule.UL_id._UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_BINDING_ID, injectorLike);
    }

    @AutoGeneratedAccessMethod
    public static final DeviceUtils _UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return (DeviceUtils) UL.factorymap.get(DeviceModule.UL_id._UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_BINDING_ID, injectorLike);
    }

    @AutoGeneratedFactoryMethod
    public static final DeviceUtils _UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_FACTORY_METHOD(InjectorLike injectorLike) {
        return new DeviceUtils(injectorLike);
    }

    @AutoGeneratedAccessMethod
    public static final Provider _UL__ULSEP_javax_inject_Provider_ULLT_com_oculus_util_device_DeviceUtils_ULGT__ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return UltralightProvider.get(DeviceModule.UL_id._UL__ULSEP_com_oculus_util_device_DeviceUtils_ULSEP_BINDING_ID, injectorLike);
    }

    @Inject
    public DeviceUtils(InjectorLike injectorLike) {
        this.mContext = BundledAndroidModule._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_UnsafeContextInjection_ULSEP_ACCESS_METHOD(injectorLike);
    }

    public boolean isSDCardAvailable() {
        return getSDCardDirectory(this.mContext) != null;
    }

    public boolean isStandAloneDevice() {
        return this.mContext.getPackageManager().hasSystemFeature(BuildConstants.PACKAGE_NAME_OVR_STANDALONE);
    }

    public static String getDeviceId(Context context) {
        String string = Settings.Secure.getString(context.getContentResolver(), "android_id");
        if (string == null) {
            string = "";
        }
        return Strings.padStart(string, 16, '0');
    }

    private static boolean isDirectoryMounted(File file) {
        if (file == null) {
            return false;
        }
        String externalStorageState = Environment.getExternalStorageState(file);
        if ("mounted".equals(externalStorageState) || "mounted_ro".equals(externalStorageState)) {
            return true;
        }
        return false;
    }

    public boolean isSDCardAvailable(Context context) {
        return getSDCardDirectory(context) != null;
    }

    public static boolean isOculusSDCardInserted() {
        String str = System.getenv("SECONDARY_STORAGE");
        if (str == null) {
            BLog.e(TAG, "SD card path is invalid");
            return false;
        }
        File file = new File(str);
        if (!file.exists() || !file.canRead()) {
            BLog.e(TAG, "SD card could not be read");
            return false;
        }
        File file2 = new File(str + "/" + OCULUS_DIR);
        if (file2.exists() && file2.canRead()) {
            return true;
        }
        BLog.e(TAG, "Oculus directory could not be read");
        return false;
    }

    public static boolean isOculusSDCardInsertedRequired() {
        return isNote4Device() && !isAndroidMarshmallowOrNewer() && !isOculusSDCardInserted();
    }

    private static boolean isAndroidMarshmallowOrNewer() {
        return Build.VERSION.SDK_INT >= 23;
    }

    public static boolean isNote4Device() {
        return isOneOfTheModels(NOTE4_MODELS, getBuildModel());
    }

    public static String getBuildModel() {
        if (Strings.isNullOrEmpty(mFakeModel)) {
            mFakeModel = initializeFakeModel();
        }
        return FAKE_MODEL_PLACEHOLDER.equals(mFakeModel) ? Build.MODEL : mFakeModel;
    }

    /* JADX WARNING: Code restructure failed: missing block: B:21:0x0039, code lost:
        if (r2 != null) goto L_0x002a;
     */
    /* JADX WARNING: Removed duplicated region for block: B:15:0x0034 A[SYNTHETIC, Splitter:B:15:0x0034] */
    /* Code decompiled incorrectly, please refer to instructions dump. */
    private static java.lang.String initializeFakeModel() {
        /*
            java.io.File r0 = new java.io.File
            java.lang.String r1 = com.oculus.util.device.DeviceUtils.MODEL_DEBUG_FILE_PATH
            r0.<init>(r1)
            boolean r1 = r0.exists()
            if (r1 == 0) goto L_0x0047
            boolean r1 = r0.isDirectory()
            if (r1 != 0) goto L_0x0047
            r1 = 0
            java.io.FileInputStream r2 = new java.io.FileInputStream     // Catch:{ IOException -> 0x0038, all -> 0x0030 }
            r2.<init>(r0)     // Catch:{ IOException -> 0x0038, all -> 0x0030 }
            java.io.BufferedReader r0 = new java.io.BufferedReader     // Catch:{ IOException -> 0x0039, all -> 0x002e }
            java.io.InputStreamReader r3 = new java.io.InputStreamReader     // Catch:{ IOException -> 0x0039, all -> 0x002e }
            r3.<init>(r2)     // Catch:{ IOException -> 0x0039, all -> 0x002e }
            r0.<init>(r3)     // Catch:{ IOException -> 0x0039, all -> 0x002e }
            java.lang.String r1 = r0.readLine()     // Catch:{ IOException -> 0x0039, all -> 0x002e }
            r0.close()     // Catch:{ IOException -> 0x0039, all -> 0x002e }
        L_0x002a:
            r2.close()     // Catch:{ IOException -> 0x003c }
            goto L_0x003c
        L_0x002e:
            r0 = move-exception
            goto L_0x0032
        L_0x0030:
            r0 = move-exception
            r2 = r1
        L_0x0032:
            if (r2 == 0) goto L_0x0037
            r2.close()     // Catch:{ IOException -> 0x0037 }
        L_0x0037:
            throw r0
        L_0x0038:
            r2 = r1
        L_0x0039:
            if (r2 == 0) goto L_0x003c
            goto L_0x002a
        L_0x003c:
            if (r1 == 0) goto L_0x0047
            com.google.common.collect.ImmutableSet<java.lang.String> r0 = com.oculus.util.device.DeviceUtils.ALL_MODELS
            boolean r0 = isOneOfTheModels(r0, r1)
            if (r0 == 0) goto L_0x0047
            return r1
        L_0x0047:
            java.lang.String r0 = "fake_placeholder"
            return r0
        */
        throw new UnsupportedOperationException("Method not decompiled: com.oculus.util.device.DeviceUtils.initializeFakeModel():java.lang.String");
    }

    public static boolean isJapanS6Device() {
        return isOneOfTheModels(JAPAN_MODELS, getBuildModel());
    }

    public static boolean isOneOfTheModels(ImmutableSet<String> immutableSet, String str) {
        UnmodifiableIterator<String> it = immutableSet.iterator();
        while (it.hasNext()) {
            if (str.contains(it.next())) {
                return true;
            }
        }
        return false;
    }

    public long getAvailableInternalMemory() {
        return getAvailableDiskSpace(Environment.getDataDirectory());
    }

    public long getAvailableExternalStorageMemory() {
        File externalStorageDirectory = Environment.getExternalStorageDirectory();
        if (externalStorageDirectory != null) {
            return getAvailableDiskSpace(externalStorageDirectory);
        }
        return 0;
    }

    public long getAvailableSDCardMemory() {
        File sDCardDirectory = getSDCardDirectory(this.mContext);
        if (sDCardDirectory != null) {
            return getAvailableDiskSpace(sDCardDirectory);
        }
        return 0;
    }

    public long getMinimumInternalMemoryInstallationTreshold() {
        int i = Settings.Secure.getInt(this.mContext.getContentResolver(), STORAGE_THRESHOLD_PERCENTAGE, 10);
        int i2 = Settings.Secure.getInt(this.mContext.getContentResolver(), STORAGE_THRESHOLD_MAX_BYTES, DEFAULT_THRESHOLD_MAX_BYTES);
        return Math.min((long) i2, (long) ((((float) i) * ((float) getAvailableInternalMemory())) / 100.0f));
    }

    public long getAvailableDiskSpace(String str) {
        return getAvailableDiskSpace(new File(str));
    }

    public long getAvailableDiskSpace(File file) {
        return new StatFs(file.getPath()).getAvailableBytes();
    }

    @Nullable
    private static File getSDCardDirectory(Context context) {
        File[] externalFilesDirs = context.getExternalFilesDirs(null);
        for (File file : externalFilesDirs) {
            if (isDirectoryMounted(file) && Environment.isExternalStorageRemovable(file)) {
                return file;
            }
        }
        return null;
    }

    @SuppressLint({"InstanceMethodCanBeStatic"})
    public boolean areDeviceIdentityFeaturesDisabled() {
        return SystemPropertiesInternal.get("debug.oculus.disable_device_identity_features").equals(ActivityConstants.Extras.WATCH_FEED_INJECTION);
    }
}
