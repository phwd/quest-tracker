package com.oculus.auth.device;

import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.ServiceConnection;
import android.os.IBinder;
import android.os.RemoteException;
import com.facebook.debug.log.BLog;
import com.facebook.inject.ApplicationScopeClassInit;
import com.facebook.inject.ApplicationScoped;
import com.facebook.inject.BundledAndroidModule;
import com.facebook.inject.FbInjector;
import com.facebook.inject.InjectionContext;
import com.facebook.inject.InjectorLike;
import com.facebook.inject.Lazy;
import com.facebook.inject.UltralightSingletonProvider;
import com.facebook.ultralight.AutoGeneratedAccessMethod;
import com.facebook.ultralight.AutoGeneratedFactoryMethod;
import com.facebook.ultralight.Dependencies;
import com.facebook.ultralight.Inject;
import com.facebook.ultralight.UL;
import com.oculus.aidl.IDeviceAuthService;
import com.oculus.auth.device.noop_subscriber.NoOpDeviceAuthTokenSubscriberModule;
import com.oculus.util.constants.OculusConstants;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentLinkedDeque;
import javax.annotation.Nullable;
import javax.inject.Provider;

@Dependencies({"_UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenSubscriber_ULSEP_BINDING_ID", "_UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID"})
@ApplicationScoped
public class DeviceAuthTokenStore {
    private static final String ACTION_REFRESH_TOKEN = "REFRESH_TOKEN";
    private static final String DEVICE_AUTH_SERVER_CLASS = "com.oculus.deviceauthserver.DeviceAuthService";
    private static final String DEVICE_AUTH_SERVER_PACKAGE = "com.oculus.deviceauthserver";
    public static final String TAG = "DeviceAuthTokenStore";
    private static volatile DeviceAuthTokenStore _UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_INSTANCE;
    private InjectionContext _UL_mInjectionContext;
    @Nullable
    private String mAuthToken = null;
    private final ConcurrentLinkedDeque<CompletableFuture<String>> mFutures = new ConcurrentLinkedDeque<>();
    final ServiceConnection mServiceConnection = new ServiceConnection() {
        /* class com.oculus.auth.device.DeviceAuthTokenStore.AnonymousClass1 */

        public void onServiceDisconnected(ComponentName componentName) {
        }

        public void onServiceConnected(ComponentName componentName, IBinder iBinder) {
            IDeviceAuthService asInterface = IDeviceAuthService.Stub.asInterface(iBinder);
            try {
                DeviceAuthTokenStore.this.mAuthToken = asInterface.getDeviceAuthToken(OculusConstants.ALPENGLOW_HW_LOGINTOKEN);
                BLog.d(DeviceAuthTokenStore.TAG, "successfully fetched auth token");
                ((DeviceAuthTokenSubscriber) FbInjector.lazyInstance(0, NoOpDeviceAuthTokenSubscriberModule.UL_id._UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenSubscriber_ULSEP_BINDING_ID, DeviceAuthTokenStore.this._UL_mInjectionContext)).onTokenRefresh((Context) FbInjector.lazyInstance(1, BundledAndroidModule.UL_id._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID, DeviceAuthTokenStore.this._UL_mInjectionContext), DeviceAuthTokenStore.this.mAuthToken);
                while (!DeviceAuthTokenStore.this.mFutures.isEmpty()) {
                    ((CompletableFuture) DeviceAuthTokenStore.this.mFutures.remove()).complete(DeviceAuthTokenStore.this.mAuthToken);
                }
            } catch (RemoteException e) {
                BLog.e(DeviceAuthTokenStore.TAG, "failed to fetch auth token", e);
                while (!DeviceAuthTokenStore.this.mFutures.isEmpty()) {
                    ((CompletableFuture) DeviceAuthTokenStore.this.mFutures.remove()).completeExceptionally(e);
                }
            } catch (Throwable th) {
                ((Context) FbInjector.lazyInstance(1, BundledAndroidModule.UL_id._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID, DeviceAuthTokenStore.this._UL_mInjectionContext)).unbindService(this);
                throw th;
            }
            ((Context) FbInjector.lazyInstance(1, BundledAndroidModule.UL_id._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID, DeviceAuthTokenStore.this._UL_mInjectionContext)).unbindService(this);
        }
    };

    @AutoGeneratedAccessMethod
    public static final Lazy _UL__ULSEP_com_facebook_inject_Lazy_ULLT_com_oculus_auth_device_DeviceAuthTokenStore_ULGT__ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return UltralightSingletonProvider.get(NoOpDeviceAuthTokenSubscriberModule.UL_id._UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_BINDING_ID, injectorLike);
    }

    @AutoGeneratedAccessMethod
    public static final DeviceAuthTokenStore _UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return (DeviceAuthTokenStore) UL.factorymap.get(NoOpDeviceAuthTokenSubscriberModule.UL_id._UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_BINDING_ID, injectorLike);
    }

    @AutoGeneratedFactoryMethod
    public static final DeviceAuthTokenStore _UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_FACTORY_METHOD(InjectorLike injectorLike) {
        if (_UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_INSTANCE == null) {
            synchronized (DeviceAuthTokenStore.class) {
                ApplicationScopeClassInit start = ApplicationScopeClassInit.start(_UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_INSTANCE, injectorLike);
                if (start != null) {
                    try {
                        _UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_INSTANCE = new DeviceAuthTokenStore(injectorLike.getApplicationInjector());
                    } finally {
                        start.finish();
                    }
                }
            }
        }
        return _UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_INSTANCE;
    }

    @AutoGeneratedAccessMethod
    public static final Provider _UL__ULSEP_javax_inject_Provider_ULLT_com_oculus_auth_device_DeviceAuthTokenStore_ULGT__ULSEP_ACCESS_METHOD(InjectorLike injectorLike) {
        return UltralightSingletonProvider.get(NoOpDeviceAuthTokenSubscriberModule.UL_id._UL__ULSEP_com_oculus_auth_device_DeviceAuthTokenStore_ULSEP_BINDING_ID, injectorLike);
    }

    @Inject
    public DeviceAuthTokenStore(InjectorLike injectorLike) {
        this._UL_mInjectionContext = new InjectionContext(2, injectorLike);
    }

    @Nullable
    public String getAuthToken() {
        return this.mAuthToken;
    }

    public CompletableFuture<String> fetchToken() {
        CompletableFuture<String> completableFuture = new CompletableFuture<>();
        this.mFutures.add(completableFuture);
        Intent intent = new Intent();
        intent.setComponent(new ComponentName(DEVICE_AUTH_SERVER_PACKAGE, DEVICE_AUTH_SERVER_CLASS));
        if (!((Context) FbInjector.lazyInstance(1, BundledAndroidModule.UL_id._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID, this._UL_mInjectionContext)).bindService(intent, this.mServiceConnection, 0)) {
            BLog.e(TAG, "failed to bind to device auth service");
            completableFuture.completeExceptionally(new Throwable("failed to bind to device auth service"));
            this.mFutures.remove(completableFuture);
        }
        return completableFuture;
    }

    public void forceTokenRefresh() {
        Intent intent = new Intent(ACTION_REFRESH_TOKEN);
        intent.setComponent(new ComponentName(DEVICE_AUTH_SERVER_PACKAGE, DEVICE_AUTH_SERVER_CLASS));
        ((Context) FbInjector.lazyInstance(1, BundledAndroidModule.UL_id._UL__ULSEP_android_content_Context_ULSEP_com_facebook_inject_ForAppContext_ULSEP_BINDING_ID, this._UL_mInjectionContext)).startService(intent);
    }
}
